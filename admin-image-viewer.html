<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Image Viewer - CCR Compliance Reviews</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Google Sans', Roboto, Arial, sans-serif;
            background-color: #f0ebf8;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 8px;
            padding: 32px 24px;
            color: white;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-left h1 {
            font-size: 28px;
            font-weight: 400;
            margin-bottom: 8px;
        }

        .header-left p {
            font-size: 14px;
            opacity: 0.9;
        }

        .user-section {
            text-align: right;
        }

        .user-email {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 8px;
        }

        .signout-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 8px 16px;
            font-size: 12px;
            font-weight: 500;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .signout-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        /* Auth Container */
        .auth-container {
            max-width: 500px;
            margin: 100px auto;
            background: white;
            border-radius: 8px;
            padding: 32px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .auth-title {
            font-size: 24px;
            color: #202124;
            margin-bottom: 24px;
            text-align: center;
        }

        .auth-input {
            width: 100%;
            padding: 12px;
            border: 1px solid #dadce0;
            border-radius: 4px;
            font-size: 14px;
            margin-bottom: 16px;
            font-family: inherit;
        }

        .auth-btn {
            width: 100%;
            background: #673ab7;
            color: white;
            border: none;
            padding: 12px 24px;
            font-size: 14px;
            font-weight: 500;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.2s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .auth-btn:hover {
            background: #5e35b1;
        }

        .auth-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        /* Filters and Search */
        .filters {
            background: white;
            border-radius: 8px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.12);
        }

        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 16px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
        }

        .filter-label {
            font-size: 12px;
            color: #5f6368;
            margin-bottom: 6px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .filter-input, .filter-select {
            padding: 10px;
            border: 1px solid #dadce0;
            border-radius: 4px;
            font-size: 14px;
            font-family: inherit;
        }

        .stats-bar {
            display: flex;
            gap: 24px;
            padding: 16px;
            background: #f8f9fa;
            border-radius: 4px;
            flex-wrap: wrap;
        }

        .stat-item {
            display: flex;
            flex-direction: column;
        }

        .stat-label {
            font-size: 12px;
            color: #5f6368;
            margin-bottom: 4px;
        }

        .stat-value {
            font-size: 20px;
            font-weight: 500;
            color: #202124;
        }

        /* Loading State */
        .loading {
            text-align: center;
            padding: 60px 20px;
            color: #5f6368;
        }

        .loading-spinner {
            width: 48px;
            height: 48px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #673ab7;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Review Cards */
        .reviews-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .review-card {
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: transform 0.2s, box-shadow 0.2s;
            cursor: pointer;
        }

        .review-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .review-header {
            padding: 16px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .review-address {
            font-size: 16px;
            font-weight: 500;
            margin-bottom: 8px;
        }

        .review-meta {
            font-size: 12px;
            opacity: 0.9;
            display: flex;
            justify-content: space-between;
        }

        .review-images {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 4px;
            padding: 12px;
            background: #f8f9fa;
        }

        .review-image-thumb {
            aspect-ratio: 1;
            overflow: hidden;
            border-radius: 4px;
            cursor: pointer;
            position: relative;
        }

        .review-image-thumb img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.2s;
        }

        .review-image-thumb:hover img {
            transform: scale(1.1);
        }

        .image-count-badge {
            position: absolute;
            bottom: 4px;
            right: 4px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 500;
        }

        .review-info {
            padding: 16px;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #f1f3f4;
            font-size: 13px;
        }

        .info-row:last-child {
            border-bottom: none;
        }

        .info-label {
            color: #5f6368;
            font-weight: 500;
        }

        .info-value {
            color: #202124;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-accept {
            background: #e8f5e9;
            color: #2e7d32;
        }

        .status-minor {
            background: #fff3e0;
            color: #f57c00;
        }

        .status-major {
            background: #ffebee;
            color: #c62828;
        }

        .status-resolved {
            background: #e8f5e9;
            color: #2e7d32;
        }

        .status-progress {
            background: #e3f2fd;
            color: #1565c0;
        }

        .status-action {
            background: #ffebee;
            color: #c62828;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.9);
            overflow: auto;
        }

        .modal-content {
            position: relative;
            max-width: 1200px;
            margin: 40px auto;
            padding: 20px;
            background: white;
            border-radius: 8px;
        }

        .modal-close {
            position: absolute;
            top: 10px;
            right: 20px;
            font-size: 36px;
            color: #5f6368;
            cursor: pointer;
            z-index: 1001;
        }

        .modal-close:hover {
            color: #202124;
        }

        .modal-header {
            padding: 20px;
            border-bottom: 2px solid #f1f3f4;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 24px;
            color: #202124;
            margin-bottom: 8px;
        }

        .modal-subtitle {
            font-size: 14px;
            color: #5f6368;
        }

        .modal-body {
            padding: 20px;
        }

        .modal-section {
            margin-bottom: 32px;
        }

        .modal-section-title {
            font-size: 18px;
            color: #202124;
            margin-bottom: 16px;
            padding-bottom: 8px;
            border-bottom: 2px solid #f1f3f4;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .modal-images-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .modal-image {
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: transform 0.2s;
        }

        .modal-image:hover {
            transform: scale(1.05);
        }

        .modal-image img {
            width: 100%;
            height: 200px;
            object-fit: cover;
            display: block;
        }

        .detail-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 16px;
        }

        .detail-item {
            padding: 12px;
            background: #f8f9fa;
            border-radius: 4px;
        }

        .detail-label {
            font-size: 12px;
            color: #5f6368;
            margin-bottom: 4px;
            font-weight: 500;
        }

        .detail-value {
            font-size: 14px;
            color: #202124;
        }

        .comments-box {
            padding: 16px;
            background: #f8f9fa;
            border-radius: 4px;
            border-left: 4px solid #673ab7;
            white-space: pre-wrap;
            font-size: 14px;
            color: #202124;
            line-height: 1.6;
        }

        /* Image Lightbox */
        .lightbox {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.95);
            align-items: center;
            justify-content: center;
        }

        .lightbox-content {
            max-width: 90%;
            max-height: 90%;
            object-fit: contain;
        }

        .lightbox-close {
            position: absolute;
            top: 20px;
            right: 40px;
            font-size: 48px;
            color: white;
            cursor: pointer;
            z-index: 2001;
        }

        .lightbox-nav {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            font-size: 48px;
            color: white;
            cursor: pointer;
            padding: 16px;
            user-select: none;
        }

        .lightbox-prev {
            left: 20px;
        }

        .lightbox-next {
            right: 20px;
        }

        .no-results {
            text-align: center;
            padding: 60px 20px;
            color: #5f6368;
        }

        .no-results-icon {
            font-size: 64px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .error-message {
            background: #ffebee;
            color: #c62828;
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
        }

        @media (max-width: 768px) {
            .reviews-grid {
                grid-template-columns: 1fr;
            }

            .filters-grid {
                grid-template-columns: 1fr;
            }

            .header {
                flex-direction: column;
                text-align: center;
            }

            .user-section {
                text-align: center;
                margin-top: 16px;
            }
        }
    </style>
</head>
<body>
    <!-- Auth Container -->
    <div id="authContainer" class="auth-container">
        <h2 class="auth-title">🔒 Admin Sign In</h2>
        <p style="text-align: center; color: #5f6368; margin-bottom: 24px;">
            Sign in to view compliance review submissions
        </p>
        <input type="email" id="adminEmail" class="auth-input" placeholder="Admin Email">
        <input type="password" id="adminPassword" class="auth-input" placeholder="Password">
        <button id="signInBtn" class="auth-btn">Sign In</button>
        <p style="text-align: center; margin-top: 16px; color: #5f6368; font-size: 12px;">
            Only authorized administrators can access this page
        </p>
    </div>

    <!-- Main Container -->
    <div id="mainContainer" class="container" style="display: none;">
        <div class="header">
            <div class="header-left">
                <h1>📷 Compliance Review Image Viewer</h1>
                <p>View and manage property inspection submissions</p>
            </div>
            <div class="user-section">
                <div class="user-email" id="userEmail"></div>
                <button class="signout-btn" id="signOutBtn">Sign Out</button>
            </div>
        </div>

        <div class="filters">
            <div class="filters-grid">
                <div class="filter-group">
                    <label class="filter-label">Search Address</label>
                    <input type="text" id="searchAddress" class="filter-input" placeholder="Enter property address...">
                </div>
                <div class="filter-group">
                    <label class="filter-label">Review Team</label>
                    <input type="text" id="searchTeam" class="filter-input" placeholder="Enter reviewer name...">
                </div>
                <div class="filter-group">
                    <label class="filter-label">Date From</label>
                    <input type="date" id="dateFrom" class="filter-input">
                </div>
                <div class="filter-group">
                    <label class="filter-label">Date To</label>
                    <input type="date" id="dateTo" class="filter-input">
                </div>
                <div class="filter-group">
                    <label class="filter-label">Compliance Status</label>
                    <select id="filterStatus" class="filter-select">
                        <option value="">All Statuses</option>
                        <option value="resolved">Resolved</option>
                        <option value="in-progress">In Progress</option>
                        <option value="further-action">Further Action Required</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label class="filter-label">Has Images</label>
                    <select id="filterImages" class="filter-select">
                        <option value="">All</option>
                        <option value="yes">With Images</option>
                        <option value="no">No Images</option>
                    </select>
                </div>
            </div>
            <div class="stats-bar">
                <div class="stat-item">
                    <span class="stat-label">Total Reviews</span>
                    <span class="stat-value" id="totalReviews">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">With Images</span>
                    <span class="stat-value" id="reviewsWithImages">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Total Images</span>
                    <span class="stat-value" id="totalImages">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Showing</span>
                    <span class="stat-value" id="showingCount">0</span>
                </div>
            </div>
        </div>

        <div id="loadingContainer" class="loading">
            <div class="loading-spinner"></div>
            <div>Loading compliance reviews...</div>
        </div>

        <div id="errorContainer" style="display: none;"></div>

        <div id="reviewsContainer" class="reviews-grid"></div>

        <div id="noResults" class="no-results" style="display: none;">
            <div class="no-results-icon">📋</div>
            <h3>No reviews found</h3>
            <p>Try adjusting your filters or check back later</p>
        </div>
    </div>

    <!-- Detail Modal -->
    <div id="detailModal" class="modal">
        <div class="modal-content">
            <span class="modal-close" id="modalClose">&times;</span>
            <div class="modal-header">
                <h2 class="modal-title" id="modalTitle"></h2>
                <p class="modal-subtitle" id="modalSubtitle"></p>
            </div>
            <div class="modal-body" id="modalBody"></div>
        </div>
    </div>

    <!-- Image Lightbox -->
    <div id="lightbox" class="lightbox">
        <span class="lightbox-close" id="lightboxClose">&times;</span>
        <span class="lightbox-nav lightbox-prev" id="lightboxPrev">‹</span>
        <span class="lightbox-nav lightbox-next" id="lightboxNext">›</span>
        <img class="lightbox-content" id="lightboxImage">
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, query, orderBy, getDocs, where } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';

        // TODO: Replace with your Firebase configuration (same as the form)
        const firebaseConfig = {
          apiKey: "AIzaSyAxwLLF5FNw2u7qtYe8YigXgVpD1rkufk8",
          authDomain: "sunrise-ccr-compliance.firebaseapp.com",
          projectId: "sunrise-ccr-compliance",
          storageBucket: "sunrise-ccr-compliance.firebasestorage.app",
          messagingSenderId: "609348961099",
          appId: "1:609348961099:web:ef08e0b3053e0ec1415ece"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // State
        let allReviews = [];
        let filteredReviews = [];
        let currentLightboxImages = [];
        let currentLightboxIndex = 0;

        // DOM Elements
        const authContainer = document.getElementById('authContainer');
        const mainContainer = document.getElementById('mainContainer');
        const adminEmail = document.getElementById('adminEmail');
        const adminPassword = document.getElementById('adminPassword');
        const signInBtn = document.getElementById('signInBtn');
        const signOutBtn = document.getElementById('signOutBtn');
        const userEmail = document.getElementById('userEmail');
        const loadingContainer = document.getElementById('loadingContainer');
        const errorContainer = document.getElementById('errorContainer');
        const reviewsContainer = document.getElementById('reviewsContainer');
        const noResults = document.getElementById('noResults');

        // Filter elements
        const searchAddress = document.getElementById('searchAddress');
        const searchTeam = document.getElementById('searchTeam');
        const dateFrom = document.getElementById('dateFrom');
        const dateTo = document.getElementById('dateTo');
        const filterStatus = document.getElementById('filterStatus');
        const filterImages = document.getElementById('filterImages');

        // Stats elements
        const totalReviews = document.getElementById('totalReviews');
        const reviewsWithImages = document.getElementById('reviewsWithImages');
        const totalImages = document.getElementById('totalImages');
        const showingCount = document.getElementById('showingCount');

        // Modal elements
        const detailModal = document.getElementById('detailModal');
        const modalClose = document.getElementById('modalClose');
        const modalTitle = document.getElementById('modalTitle');
        const modalSubtitle = document.getElementById('modalSubtitle');
        const modalBody = document.getElementById('modalBody');

        // Lightbox elements
        const lightbox = document.getElementById('lightbox');
        const lightboxClose = document.getElementById('lightboxClose');
        const lightboxImage = document.getElementById('lightboxImage');
        const lightboxPrev = document.getElementById('lightboxPrev');
        const lightboxNext = document.getElementById('lightboxNext');

        // Auth State
        onAuthStateChanged(auth, (user) => {
            if (user) {
                authContainer.style.display = 'none';
                mainContainer.style.display = 'block';
                userEmail.textContent = user.email;
                loadReviews();
            } else {
                authContainer.style.display = 'block';
                mainContainer.style.display = 'none';
            }
        });

        // Sign In
        signInBtn.addEventListener('click', async () => {
            const email = adminEmail.value;
            const password = adminPassword.value;

            if (!email || !password) {
                showError('Please enter email and password');
                return;
            }

            signInBtn.disabled = true;
            signInBtn.textContent = 'Signing In...';

            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                console.error('Sign in error:', error);
                showError('Sign in failed: ' + error.message);
            } finally {
                signInBtn.disabled = false;
                signInBtn.textContent = 'Sign In';
            }
        });

        // Sign Out
        signOutBtn.addEventListener('click', async () => {
            try {
                await signOut(auth);
                adminEmail.value = '';
                adminPassword.value = '';
            } catch (error) {
                console.error('Sign out error:', error);
                showError('Sign out failed: ' + error.message);
            }
        });

        // Load Reviews
        async function loadReviews() {
            loadingContainer.style.display = 'block';
            reviewsContainer.innerHTML = '';
            errorContainer.style.display = 'none';
            noResults.style.display = 'none';

            try {
                const q = query(collection(db, "complianceReviews"), orderBy("submittedAt", "desc"));
                const querySnapshot = await getDocs(q);

                allReviews = [];
                querySnapshot.forEach((doc) => {
                    allReviews.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });

                updateStats();
                applyFilters();

            } catch (error) {
                console.error("Error loading reviews:", error);
                showError('Error loading reviews: ' + error.message);
            } finally {
                loadingContainer.style.display = 'none';
            }
        }

        // Update Statistics
        function updateStats() {
            totalReviews.textContent = allReviews.length;

            const withImages = allReviews.filter(r => r.images && r.images.length > 0).length;
            reviewsWithImages.textContent = withImages;

            const totalImgs = allReviews.reduce((sum, r) => sum + (r.imageCount || 0), 0);
            totalImages.textContent = totalImgs;
        }

        // Apply Filters
        function applyFilters() {
            filteredReviews = allReviews.filter(review => {
                // Address filter
                if (searchAddress.value && !review.propertyAddress?.toLowerCase().includes(searchAddress.value.toLowerCase())) {
                    return false;
                }

                // Team filter
                if (searchTeam.value && !review.reviewTeam?.toLowerCase().includes(searchTeam.value.toLowerCase())) {
                    return false;
                }

                // Date filters
                const reviewDate = new Date(review.date);
                if (dateFrom.value && reviewDate < new Date(dateFrom.value)) {
                    return false;
                }
                if (dateTo.value && reviewDate > new Date(dateTo.value)) {
                    return false;
                }

                // Status filter
                if (filterStatus.value && review.complianceStatus !== filterStatus.value) {
                    return false;
                }

                // Images filter
                if (filterImages.value === 'yes' && (!review.images || review.images.length === 0)) {
                    return false;
                }
                if (filterImages.value === 'no' && review.images && review.images.length > 0) {
                    return false;
                }

                return true;
            });

            showingCount.textContent = filteredReviews.length;
            displayReviews();
        }

        // Display Reviews
        function displayReviews() {
            reviewsContainer.innerHTML = '';

            if (filteredReviews.length === 0) {
                noResults.style.display = 'block';
                return;
            }

            noResults.style.display = 'none';

            filteredReviews.forEach(review => {
                const card = createReviewCard(review);
                reviewsContainer.appendChild(card);
            });
        }

        // Create Review Card
        function createReviewCard(review) {
            const card = document.createElement('div');
            card.className = 'review-card';
            card.onclick = () => showDetailModal(review);

            const date = new Date(review.date).toLocaleDateString();
            const submittedDate = new Date(review.submittedAt).toLocaleDateString();

            let imagesHTML = '';
            if (review.images && review.images.length > 0) {
                const displayImages = review.images.slice(0, 4);
                imagesHTML = `
                    <div class="review-images">
                        ${displayImages.map((url, idx) => `
                            <div class="review-image-thumb" onclick="event.stopPropagation(); openLightbox(${JSON.stringify(review.images).replace(/"/g, '&quot;')}, ${idx})">
                                <img src="${url}" alt="Property image ${idx + 1}">
                                ${idx === 3 && review.images.length > 4 ? `<div class="image-count-badge">+${review.images.length - 4}</div>` : ''}
                            </div>
                        `).join('')}
                    </div>
                `;
            }

            card.innerHTML = `
                <div class="review-header">
                    <div class="review-address">${review.propertyAddress || 'No address'}</div>
                    <div class="review-meta">
                        <span>📅 ${date}</span>
                        <span>📷 ${review.imageCount || 0} photos</span>
                    </div>
                </div>
                ${imagesHTML}
                <div class="review-info">
                    <div class="info-row">
                        <span class="info-label">Review Team</span>
                        <span class="info-value">${review.reviewTeam || 'N/A'}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Submitted</span>
                        <span class="info-value">${submittedDate} by ${review.submittedBy || 'Unknown'}</span>
                    </div>
                    ${review.complianceStatus ? `
                        <div class="info-row">
                            <span class="info-label">Status</span>
                            <span class="status-badge status-${review.complianceStatus}">
                                ${formatStatus(review.complianceStatus)}
                            </span>
                        </div>
                    ` : ''}
                </div>
            `;

            return card;
        }

        // Show Detail Modal
        function showDetailModal(review) {
            modalTitle.textContent = review.propertyAddress || 'Property Review';
            modalSubtitle.textContent = `Reviewed by ${review.reviewTeam || 'Unknown'} on ${new Date(review.date).toLocaleDateString()}`;

            let modalContent = '';

            // Images Section
            if (review.images && review.images.length > 0) {
                modalContent += `
                    <div class="modal-section">
                        <h3 class="modal-section-title">📷 Property Images (${review.images.length})</h3>
                        <div class="modal-images-grid">
                            ${review.images.map((url, idx) => `
                                <div class="modal-image" onclick="openLightbox(${JSON.stringify(review.images).replace(/"/g, '&quot;')}, ${idx})">
                                    <img src="${url}" alt="Property image ${idx + 1}">
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }

            // Basic Information
            modalContent += `
                <div class="modal-section">
                    <h3 class="modal-section-title">📋 Basic Information</h3>
                    <div class="detail-grid">
                        <div class="detail-item">
                            <div class="detail-label">Property Address</div>
                            <div class="detail-value">${review.propertyAddress || 'N/A'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Review Date</div>
                            <div class="detail-value">${new Date(review.date).toLocaleDateString()}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Review Team</div>
                            <div class="detail-value">${review.reviewTeam || 'N/A'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Submitted By</div>
                            <div class="detail-value">${review.submittedBy || 'N/A'}</div>
                        </div>
                    </div>
                </div>
            `;

            // Inspection Results
            modalContent += `
                <div class="modal-section">
                    <h3 class="modal-section-title">✅ Inspection Results</h3>
                    <div class="detail-grid">
                        ${createDetailItem('Overall Appearance', review.overallAppearance)}
                        ${createDetailItem('Paint/Stucco', review.paintStucco)}
                        ${createDetailItem('Tile Roof', review.tileRoof)}
                        ${createDetailItem('Gutters', review.gutters)}
                        ${createDetailItem('Windows', review.windows)}
                        ${createDetailItem('Doors', review.doors)}
                        ${createDetailItem('Fencing', review.fencing)}
                        ${createDetailItem('Driveway', review.driveway)}
                        ${createDetailItem('Walkways', review.walkways)}
                        ${createDetailItem('Landscape Overall', review.landscapeOverall)}
                        ${createDetailItem('Ground Cover', review.groundCover)}
                        ${createDetailItem('Trees & Shrubs', review.treesShrubs)}
                        ${createDetailItem('Dead Plants', review.deadPlants)}
                        ${createDetailItem('Mistletoe', review.mistletoe)}
                        ${createDetailItem('Rocks/Gravel', review.rocksGravel)}
                        ${createDetailItem('Mailbox', review.mailbox)}
                        ${createDetailItem('Lamppost', review.lamppost)}
                        ${createDetailItem('House Numbers', review.houseNumbers)}
                        ${createDetailItem('Exterior Lighting', review.exteriorLighting)}
                        ${createDetailItem('Trash/Debris', review.trashDebris)}
                        ${createDetailItem('Trash Cans', review.trashCans)}
                        ${createDetailItem('Unauthorized Structures', review.unauthorizedStructures)}
                        ${createDetailItem('Inoperable Vehicles', review.inoperableVehicles)}
                        ${createDetailItem('Commercial Vehicles', review.commercialVehicles)}
                        ${createDetailItem('Approved Parking', review.approvedParking)}
                    </div>
                </div>
            `;

            // Comments
            if (review.detailedComments) {
                modalContent += `
                    <div class="modal-section">
                        <h3 class="modal-section-title">💬 Detailed Comments</h3>
                        <div class="comments-box">${review.detailedComments}</div>
                    </div>
                `;
            }

            // Follow-up Actions
            modalContent += `
                <div class="modal-section">
                    <h3 class="modal-section-title">📝 Follow-up Actions</h3>
                    <div class="detail-grid">
                        ${createDetailItem('Violation Notice Sent', review.violationNotice === 'yes' ? 'Yes' : 'No')}
                        ${review.violationNoticeDate ? createDetailItem('Notice Date', new Date(review.violationNoticeDate).toLocaleDateString()) : ''}
                        ${review.complianceDeadline ? createDetailItem('Compliance Deadline', new Date(review.complianceDeadline).toLocaleDateString()) : ''}
                        ${review.reinspectionDate ? createDetailItem('Re-inspection Date', new Date(review.reinspectionDate).toLocaleDateString()) : ''}
                        ${review.complianceStatus ? createDetailItem('Compliance Status', formatStatus(review.complianceStatus)) : ''}
                    </div>
                </div>
            `;

            modalBody.innerHTML = modalContent;
            detailModal.style.display = 'block';
        }

        // Create Detail Item
        function createDetailItem(label, value) {
            if (!value) return '';
            return `
                <div class="detail-item">
                    <div class="detail-label">${label}</div>
                    <div class="detail-value">
                        ${value === 'accept' || value === 'minor' || value === 'major' || value === 'na'
                            ? `<span class="status-badge status-${value}">${value.toUpperCase()}</span>`
                            : value
                        }
                    </div>
                </div>
            `;
        }

        // Format Status
        function formatStatus(status) {
            return status.split('-').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
        }

        // Lightbox Functions
        window.openLightbox = function(images, index) {
            currentLightboxImages = images;
            currentLightboxIndex = index;
            showLightboxImage();
            lightbox.style.display = 'flex';
        };

        function showLightboxImage() {
            lightboxImage.src = currentLightboxImages[currentLightboxIndex];
        }

        lightboxClose.onclick = () => lightbox.style.display = 'none';
        lightbox.onclick = (e) => {
            if (e.target === lightbox) lightbox.style.display = 'none';
        };

        lightboxPrev.onclick = () => {
            currentLightboxIndex = (currentLightboxIndex - 1 + currentLightboxImages.length) % currentLightboxImages.length;
            showLightboxImage();
        };

        lightboxNext.onclick = () => {
            currentLightboxIndex = (currentLightboxIndex + 1) % currentLightboxImages.length;
            showLightboxImage();
        };

        // Keyboard navigation for lightbox
        document.addEventListener('keydown', (e) => {
            if (lightbox.style.display === 'flex') {
                if (e.key === 'ArrowLeft') lightboxPrev.onclick();
                if (e.key === 'ArrowRight') lightboxNext.onclick();
                if (e.key === 'Escape') lightboxClose.onclick();
            }
        });

        // Modal Close
        modalClose.onclick = () => detailModal.style.display = 'none';
        window.onclick = (e) => {
            if (e.target === detailModal) detailModal.style.display = 'none';
        };

        // Filter Event Listeners
        searchAddress.addEventListener('input', applyFilters);
        searchTeam.addEventListener('input', applyFilters);
        dateFrom.addEventListener('change', applyFilters);
        dateTo.addEventListener('change', applyFilters);
        filterStatus.addEventListener('change', applyFilters);
        filterImages.addEventListener('change', applyFilters);

        // Show Error
        function showError(message) {
            errorContainer.innerHTML = `<div class="error-message">${message}</div>`;
            errorContainer.style.display = 'block';
            setTimeout(() => {
                errorContainer.style.display = 'none';
            }, 5000);
        }

        // Allow Enter key for sign in
        adminPassword.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') signInBtn.click();
        });
    </script>
</body>
</html>
